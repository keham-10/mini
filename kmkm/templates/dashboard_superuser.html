{% extends "base.html" %}

{% block title %}Admin Dashboard - SecureSphere{% endblock %}

{% block content %}
<!-- Enhanced Dashboard Header -->
<div class="dashboard-header text-center mb-5">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold mb-2 text-start" style="color: white;">
                <i class="bi bi-shield-shaded me-3" style="color: rgba(255,255,255,0.9);"></i>Admin Dashboard
            </h1>
            <p class="lead mb-0 text-start" style="color: rgba(255,255,255,0.8);">
                Comprehensive system management and oversight
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="admin-badge">
                <span class="badge bg-light text-dark px-3 py-2 rounded-pill">
                    <i class="bi bi-person-gear me-2"></i>Administrator
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Statistics Dashboard -->
<div class="row g-4 mb-5">
    <!-- Total Products Card -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-white-50 small fw-bold text-uppercase mb-1">Total Products</div>
                        <div class="h2 mb-0 fw-bold text-white">{{ products_data|length }}</div>
                        <div class="text-white-50 small">
                            <i class="bi bi-arrow-up me-1"></i>Active assessments
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-box-seam fs-1 text-white opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Average Score Card -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-white-50 small fw-bold text-uppercase mb-1">Avg Maturity Score</div>
                        <div class="h2 mb-0 fw-bold text-white">
                            {% set total_maturity = products_data|map(attribute='maturity_score')|sum %}
                            {% if products_data|length > 0 %}
                                {{ "%.1f"|format(total_maturity / products_data|length) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </div>
                        <div class="text-white-50 small">
                            <i class="bi bi-trend-up me-1"></i>Overall performance
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-graph-up fs-1 text-white opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- In Progress Card -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-white-50 small fw-bold text-uppercase mb-1">In Progress</div>
                        <div class="h2 mb-0 fw-bold text-white">
                            {% set in_progress_count = products_data|selectattr('product.status', 'in', ['in_progress', 'under_review', 'questions_done'])|list|length %}
                            {{ in_progress_count }}
                        </div>
                        <div class="text-white-50 small">
                            <i class="bi bi-clock me-1"></i>Active assessments
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-hourglass-split fs-1 text-white opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Completed Card -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #e74a3b 0%, #c0392b 100%);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-white-50 small fw-bold text-uppercase mb-1">Completed</div>
                        <div class="h2 mb-0 fw-bold text-white">
                            {% set completed_count = products_data|selectattr('product.status', 'in', ['completed', 'review_done'])|list|length %}
                            {{ completed_count }}
                        </div>
                        <div class="text-white-50 small">
                            <i class="bi bi-check-circle me-1"></i>Finished assessments
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-check-circle fs-1 text-white opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Management Actions Row -->
<div class="row g-4 mb-5">
    <!-- Quick Actions Card -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="mb-0 text-dark d-flex align-items-center">
                    <i class="bi bi-lightning-charge me-2 text-primary"></i>Quick Actions
                    <span class="badge bg-primary rounded-pill ms-auto">4</span>
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <a href="{{ url_for('admin_create_product') }}" class="btn btn-primary w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-plus-circle me-2"></i>Create Product
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('manage_users') }}" class="btn btn-success w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-people me-2"></i>Manage Users
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('invite_client') }}" class="btn btn-info w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-person-plus me-2"></i>Invite Users
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('manage_clients') }}" class="btn btn-warning w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-people-fill me-2"></i>Manage Clients
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Management Card -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="mb-0 text-dark d-flex align-items-center">
                    <i class="bi bi-gear me-2 text-primary"></i>System Management
                    <span class="badge bg-secondary rounded-pill ms-auto">3</span>
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <a href="{{ url_for('admin_client_management') }}" class="btn btn-outline-primary w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-kanban me-2"></i>Client Overview
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('admin_all_products') }}" class="btn btn-outline-secondary w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-collection me-2"></i>All Products
                        </a>
                    </div>
                    <div class="col-md-12">
                        <a href="{{ url_for('admin_invite_reviewer') }}" class="btn btn-outline-info w-100 py-3 rounded-3 shadow-sm">
                            <i class="bi bi-person-check me-2"></i>Invite Reviewer
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics and Recent Activity Row -->
<div class="row g-4 mb-4">
    <!-- Analytics Chart -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-bar-chart me-2 text-primary"></i>Security Assessment Analytics
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Last 30 Days
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Last 7 Days</a></li>
                            <li><a class="dropdown-item" href="#">Last 30 Days</a></li>
                            <li><a class="dropdown-item" href="#">Last 90 Days</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="organizationChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Panel -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="mb-0 text-dark">
                    <i class="bi bi-clock-history me-2 text-primary"></i>Recent Activity
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for product_data in products_data[:5] %}
                    <div class="list-group-item border-0 py-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                {% if product_data.product.status == 'completed' %}
                                    <div class="badge bg-success rounded-circle p-2">
                                        <i class="bi bi-check"></i>
                                    </div>
                                {% elif product_data.product.status == 'in_progress' %}
                                    <div class="badge bg-warning rounded-circle p-2">
                                        <i class="bi bi-clock"></i>
                                    </div>
                                {% else %}
                                    <div class="badge bg-info rounded-circle p-2">
                                        <i class="bi bi-eye"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-semibold text-dark small">{{ product_data.product.name }}</div>
                                <div class="text-muted small">Score: {{ product_data.maturity_score }}%</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="card-footer bg-light border-0 text-center">
                    <a href="{{ url_for('admin_all_products') }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-arrow-right me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status Footer -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-1 text-dark">
                            <i class="bi bi-shield-check me-2 text-success"></i>System Status: Online
                        </h6>
                        <p class="mb-0 text-muted small">All systems operational • Last updated: {{ moment().format('MMM DD, YYYY HH:mm') }}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="d-flex align-items-center justify-content-md-end">
                            <span class="badge bg-success me-2">
                                <i class="bi bi-check-circle me-1"></i>Healthy
                            </span>
                            <small class="text-muted">{{ products_data|length }} active assessments</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Organization Chart
    const ctx = document.getElementById('organizationChart').getContext('2d');
    
    // Sample data - in real implementation, this would come from the backend
    const chartData = {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [
            {
                label: 'Completed Assessments',
                data: [12, 19, 8, 15],
                backgroundColor: 'rgba(28, 200, 138, 0.2)',
                borderColor: 'rgba(28, 200, 138, 1)',
                borderWidth: 2,
                tension: 0.4
            },
            {
                label: 'New Products',
                data: [8, 12, 15, 10],
                backgroundColor: 'rgba(78, 115, 223, 0.2)',
                borderColor: 'rgba(78, 115, 223, 1)',
                borderWidth: 2,
                tension: 0.4
            }
        ]
    };

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Add hover effects to cards
    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>

<style>
.admin-badge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
}

.stat-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
}

.list-group-item {
    transition: background-color 0.2s ease;
}

.list-group-item:hover {
    background-color: rgba(0,0,0,0.02);
}

.chart-container {
    position: relative;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Chats - {{ product.name }} - SecureSphere{% endblock %}

{% block head %}
<style>
.chats-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.chats-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.chats-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 30px;
    height: calc(100vh - 300px);
}

.chats-sidebar {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.sidebar-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.chats-list {
    overflow-y: auto;
    height: calc(100% - 80px);
}

.chat-item {
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.chat-item:hover {
    background: #f8f9fa;
}

.chat-item.active {
    background: #e3f2fd;
    border-left: 4px solid #667eea;
}

.chat-item:last-child {
    border-bottom: none;
}

.chat-preview {
    display: flex;
    align-items: flex-start;
    gap: 15px;
}

.chat-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #28a745;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    flex-shrink: 0;
}

.chat-info {
    flex: 1;
    min-width: 0;
}

.chat-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    font-size: 0.95rem;
}

.chat-question {
    color: #666;
    font-size: 0.85rem;
    line-height: 1.3;
    margin-bottom: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.chat-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.chat-status {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-approved { background: #d1e7dd; color: #0f5132; }
.status-needs-revision { background: #f8d7da; color: #721c24; }
.status-rejected { background: #f8d7da; color: #721c24; }

.chat-time {
    font-size: 0.75rem;
    color: #999;
}

.unread-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
}

.chat-main {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #6c757d;
}

.empty-state {
    text-align: center;
    padding: 60px 40px;
}

.empty-state i {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 20px;
}

.empty-state h4 {
    color: #6c757d;
    margin-bottom: 15px;
}

.empty-state p {
    color: #adb5bd;
    margin-bottom: 0;
}

.section-badge {
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: 8px;
}

.last-message {
    font-size: 0.8rem;
    color: #666;
    font-style: italic;
    margin-top: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chat-search {
    padding: 15px 20px;
    border-bottom: 1px solid #e0e0e0;
}

.search-input {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.9rem;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
}

@media (max-width: 768px) {
    .chats-grid {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .chats-sidebar {
        height: 400px;
    }
    
    .chat-main {
        height: 500px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="chats-container">
    <!-- Header -->
    <div class="chats-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">
                    <i class="bi bi-chat-dots me-2"></i>Chats
                </h4>
                <p class="mb-0 opacity-75">{{ product.name }}</p>
            </div>
            <div class="text-end">
                <span class="badge bg-light text-dark">{{ chat_data|length }} active chats</span>
                <div class="mt-1">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="chats-grid">
        <!-- Sidebar -->
        <div class="chats-sidebar">
            <div class="sidebar-header">
                <h6 class="mb-0">
                    <i class="bi bi-list me-2"></i>Recent Chats
                    {% if current_user_role == 'lead' %}
                        <span class="badge bg-primary ms-2">{{ chat_data|selectattr('unread_count')|list|length }}</span>
                    {% endif %}
                </h6>
            </div>

            <!-- Search -->
            <div class="chat-search">
                <input type="text" class="search-input" placeholder="Search chats..." id="chatSearch">
            </div>

            <!-- Chats List -->
            <div class="chats-list">
                {% if chat_data %}
                    {% for item in chat_data %}
                        <div class="chat-item" onclick="openChat({{ item.chat.id }})" data-chat-id="{{ item.chat.id }}">
                            {% if item.unread_count > 0 %}
                                <div class="unread-badge">{{ item.unread_count }}</div>
                            {% endif %}
                            
                            <div class="chat-preview">
                                <div class="chat-avatar">
                                    {% if current_user_role == 'lead' %}
                                        {{ item.chat.client.first_name[0] if item.chat.client.first_name else item.chat.client.username[0] }}
                                    {% else %}
                                        <i class="bi bi-shield-check"></i>
                                    {% endif %}
                                </div>
                                
                                <div class="chat-info">
                                    <div class="chat-title">
                                        {% if current_user_role == 'lead' %}
                                            {{ item.chat.client.first_name or item.chat.client.username }}
                                        {% else %}
                                            {{ item.chat.lead.first_name or item.chat.lead.username }}
                                        {% endif %}
                                        <span class="section-badge">{{ item.chat.response.section }}</span>
                                    </div>
                                    
                                    <div class="chat-question">
                                        {{ item.chat.response.question }}
                                    </div>
                                    
                                    {% if item.last_message %}
                                        <div class="last-message">
                                            {{ item.last_message.content[:50] }}{% if item.last_message.content|length > 50 %}...{% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="chat-meta">
                                        <span class="chat-status status-{{ item.chat.review_status }}">
                                            {% if item.chat.review_status == 'approved' %}
                                                <i class="bi bi-check-circle me-1"></i>Approved
                                            {% elif item.chat.review_status == 'needs_revision' %}
                                                <i class="bi bi-exclamation-triangle me-1"></i>Needs Revision
                                            {% elif item.chat.review_status == 'rejected' %}
                                                <i class="bi bi-x-circle me-1"></i>Rejected
                                            {% else %}
                                                <i class="bi bi-clock me-1"></i>Pending
                                            {% endif %}
                                        </span>
                                        
                                        <span class="chat-time">
                                            {{ item.chat.updated_at.strftime('%m/%d %I:%M %p') }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-chat-dots"></i>
                        <h6>No Active Chats</h6>
                        <p>No question discussions are currently active.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="empty-state">
                <i class="bi bi-chat-square-dots"></i>
                <h4>Select a Chat</h4>
                <p>Choose a conversation from the sidebar to start chatting about specific questions.</p>
            </div>
        </div>
    </div>
</div>

<script>
function openChat(chatId) {
    // Remove active class from all chat items
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Add active class to clicked item
    document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
    
    // Navigate to chat
    window.location.href = `/question-chat/${chatId}`;
}

// Search functionality
document.getElementById('chatSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const chatItems = document.querySelectorAll('.chat-item');
    
    chatItems.forEach(item => {
        const title = item.querySelector('.chat-title').textContent.toLowerCase();
        const question = item.querySelector('.chat-question').textContent.toLowerCase();
        
        if (title.includes(searchTerm) || question.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Auto-refresh every 30 seconds to check for new messages
setInterval(function() {
    // Only refresh if we're still on the chats list page
    if (window.location.pathname.includes('/question-chats/')) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}